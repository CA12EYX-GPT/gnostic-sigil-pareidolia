<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Gnostic Sigil Pareidolia — Static (Mobile Safe)</title>
<style>
  :root{--bg:#0b0b0e;--fg:#e7fdfc;--accent:#32e0c4}
  html,body{height:100%;margin:0;background:var(--bg);color:#d7d7da;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{display:grid;grid-template-rows:auto 1fr auto; height:100dvh; gap:10px; padding:14px}
  header{display:flex;align-items:center;justify-content:space-between}
  header h1{font-size:16px;letter-spacing:.08em;text-transform:uppercase;margin:0;opacity:.9}
  #myth{font-size:12px;opacity:.85}
  .pane{position:relative;border:1px solid #1e2326;border-radius:10px;overflow:hidden;
    background:radial-gradient(120% 110% at 50% 0%,#101215 0%,#0b0b0e 70%,#08090b 100%);
    box-shadow:0 10px 40px rgba(0,0,0,.45), inset 0 0 120px rgba(0,0,0,.3);
    min-height:58vh;  /* ensure visible height on mobile */
  }
  canvas{width:100%;height:100%;display:block;image-rendering:pixelated}
  .hud{position:absolute;left:12px;bottom:12px;display:flex;gap:10px;flex-wrap:wrap;
    font-size:12px;color:#bfc8cb;background:rgba(10,12,14,.35);
    border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(4px);
    padding:8px 10px;border-radius:8px}
  .hud label{display:grid;gap:4px}
  .hud input[type="range"]{width:120px}
  .btn{background:#11161a;color:#dfe5e7;border:1px solid #222b2f;padding:6px 9px;border-radius:6px}
  .lamp{display:inline-flex;align-items:center;gap:6px;padding:4px 7px;border-radius:6px;border:1px solid #223037;background:#0d1417;color:#b4ffef}
  .lamp .dot{width:6px;height:6px;border-radius:50%;background:#223b37;box-shadow:0 0 8px rgba(50,224,196,.2)}
  .lamp.on .dot{background:var(--accent);box-shadow:0 0 16px rgba(50,224,196,.75)}
  footer{display:flex;align-items:center;justify-content:space-between;gap:12px;font-size:12px;opacity:.9}
  code.k{background:#0f1518;border:1px solid #1d262b;padding:2px 6px;border-radius:6px}
  .log{max-width:52ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Gnostic Sigil Pareidolia — Static</h1>
    <div id="myth">“The channel is always open; you’re just learning where to look.”</div>
  </header>

  <div class="pane">
    <canvas id="snow"></canvas>
    <div class="hud">
      <span class="lamp" id="scryLamp"><span class="dot"></span> Scry</span>
      <label>Density <input type="range" id="density" min="0" max="1" step="0.01" value="0.62"></label>
      <label>Contrast <input type="range" id="contrast" min="0.5" max="3" step="0.01" value="1.35"></label>
      <label>Flicker Hz <input type="range" id="flicker" min="0" max="30" step="0.1" value="7.5"></label>
      <label>Drift <input type="range" id="drift" min="0" max="1" step="0.01" value="0.35"></label>
      <label>Hints <input type="range" id="hint" min="0" max="1" step="0.01" value="0.18"></label>
      <button class="btn" id="seedBtn">Reroll</button>
      <button class="btn" id="markBtn">I saw something</button>
    </div>
  </div>

  <footer>
    <div>Keys: <code class="k">H</code> hints, <code class="k">S</code> scry, <code class="k">Space</code> mark, <code class="k">R</code> reroll, <code class="k">G</code> glow word.</div>
    <div class="log" id="lastMark">No marks yet.</div>
  </footer>
</div>

<script>
(() => {
  const canvas = document.getElementById('snow');
  const ctx = canvas.getContext('2d', { alpha:false, willReadFrequently:true });
  const glog = document.getElementById('lastMark');
  const lamp = document.getElementById('scryLamp');
  const dSlider = document.getElementById('density');
  const cSlider = document.getElementById('contrast');
  const fSlider = document.getElementById('flicker');
  const driftSlider = document.getElementById('drift');
  const hintSlider = document.getElementById('hint');
  document.getElementById('seedBtn').onclick = () => { reseed(); latentSigil = makeSigil(); };
  document.getElementById('markBtn').onclick = markMoment;

  // Sizing (use CSS pixel size, draw at devicePixelRatio internally)
  let wCSS=0,hCSS=0, DPR=Math.max(1, Math.min(2, window.devicePixelRatio||1));
  function resize(){
    const r = canvas.parentElement.getBoundingClientRect();
    wCSS = Math.max(300, Math.floor(r.width));
    hCSS = Math.max(240, Math.floor(r.height));
    canvas.width  = Math.floor(wCSS * DPR);
    canvas.height = Math.floor(hCSS * DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
    // refresh buffers
    img = ctx.createImageData(wCSS, hCSS);
    fieldA = new Uint8ClampedArray(wCSS*hCSS);
    fieldB = new Uint8ClampedArray(wCSS*hCSS);
  }
  addEventListener('resize', resize, {passive:true});
  resize();

  // RNG (xorshift)
  let seed = (Math.random()*1e9)|0;
  function rng(){ let x=seed|=0; x^=x<<13; x^=x>>>17; x^=x<<5; seed=x>>>0; return (seed>>>0)/4294967296; }
  function reseed(){ seed = ((performance.now()*1000)|0) ^ ((Math.random()*1e9)|0); }

  // Mobile-safe latent sigil: OffscreenCanvas fallback
  function getCompatCanvas(w,h){
    try {
      if (typeof OffscreenCanvas !== 'undefined') return new OffscreenCanvas(w,h);
    } catch(_) {}
    const c = document.createElement('canvas'); c.width=w; c.height=h; return c;
  }

  function makeSigil(){
    const w=256, h=256;
    const off = getCompatCanvas(w,h);
    const oc = off.getContext('2d');
    oc.clearRect(0,0,w,h);
    oc.globalCompositeOperation = 'lighter';
    const blobs = 6 + (rng()*6|0);
    for(let i=0;i<blobs;i++){
      const cx=(rng()*0.6+0.2)*w, cy=(rng()*0.6+0.2)*h, r=(rng()*40+18), a=0.02+rng()*0.035;
      radial(oc,cx,cy,r,a); radial(oc,w-cx,cy,r*0.92,a*0.9);
    }
    oc.globalAlpha=0.06; oc.lineWidth=2; oc.strokeStyle='#fff';
    for(let i=0;i<4;i++){ oc.beginPath(); oc.moveTo(rng()*w, rng()*h); oc.quadraticCurveTo(rng()*w, rng()*h, rng()*w, rng()*h); oc.stroke(); }
    return off;
    function radial(c,x,y,r,a){ const g=c.createRadialGradient(x,y,0,x,y,r); g.addColorStop(0,`rgba(255,255,255,${a})`); g.addColorStop(1,'rgba(255,255,255,0)'); c.fillStyle=g; c.beginPath(); c.arc(x,y,r,0,Math.PI*2); c.fill(); }
  }

  let fieldA = new Uint8ClampedArray(wCSS*hCSS);
  let fieldB = new Uint8ClampedArray(wCSS*hCSS);
  let img = ctx.createImageData(wCSS, hCSS);
  let latentSigil = makeSigil();
  let t=0;

  function makeField(buf,w,h,density){
    for(let i=0;i<w*h;i++){ buf[i] = (rng() < density) ? 255 : 0; }
  }
  function frame(){
    const w = img.width, h = img.height;
    // flicker & drift
    const hz = parseFloat(fSlider.value);
    const step = hz<=0 ? 999 : Math.max(1, Math.floor(60/Math.max(1,hz)));
    if ((t % step) === 0) makeField(fieldA, w, h, parseFloat(dSlider.value));
    if ((t % (step*2)) === 0) makeField(fieldB, w, h, Math.min(0.98, parseFloat(dSlider.value)*0.96 + 0.02));

    const drift = parseFloat(driftSlider.value);
    const contrast = parseFloat(cSlider.value);
    const hints = parseFloat(hintSlider.value);

    // write into single reused ImageData (perf on iOS)
    const data = img.data;
    for (let i=0,px=0;i<w*h;i++,px+=4){
      const a=fieldA[i]||0, b=fieldB[i]||0;
      let v = a*(1-drift) + b*drift + (rng()*35 - 17);
      let n = Math.max(0, Math.min(255, ((v-128)*contrast)+128));
      data[px]=data[px+1]=data[px+2]=n; data[px+3]=255;
    }
    ctx.putImageData(img,0,0);

    // draw hint mask (fallback canvas is fine on iOS)
    if (hints>0.001){
      const s = latentSigil;
      const lw = Math.floor(w*0.9), lh = Math.floor(h*0.9);
      const dx = Math.floor((w-lw)/2 + Math.sin(t*0.003)*w*0.02);
      const dy = Math.floor((h-lh)/2 + Math.cos(t*0.002)*h*0.02);
      ctx.globalAlpha = hints*0.65;
      ctx.globalCompositeOperation = 'screen';
      ctx.drawImage(s, dx, dy, lw, lh);
      ctx.globalAlpha = 1; ctx.globalCompositeOperation = 'source-over';
    }

    t++; requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);

  // Scry mode + tiny rituals
  let scry=false;
  function toggleScry(to){ scry = (to===undefined)?!scry:!!to; lamp.classList.toggle('on', scry);
    if (scry){ cSlider.value=(+cSlider.value*1.25).toFixed(2); fSlider.value=Math.max(0,(+fSlider.value*0.45)).toFixed(2); driftSlider.value=Math.max(0.08,(+driftSlider.value*0.6)).toFixed(2); hintSlider.value=Math.min(0.45,(+hintSlider.value+0.06)).toFixed(2);
      document.getElementById('myth').textContent='“Hold your breath on the exhale; the channel brightens.”';
    } else { document.getElementById('myth').textContent='“The channel is always open; you’re just learning where to look.”'; }
  }
  lamp.onclick=()=>toggleScry();

  function markMoment(){ const stamp=new Date().toLocaleTimeString(); glog.textContent=`Marked at ${stamp} — “Noted an appearance.”`; }
  function glowWord(){
    const words=['SEEN','TRACE','LISTEN','VEIL','ARCHIVE','ECHO','FATE','GNOSIS'];
    const w=words[(Math.random()*words.length)|0];
    const el=document.createElement('div');
    Object.assign(el.style,{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-50%)',color:'var(--fg)',fontWeight:'600',letterSpacing:'0.28em',textTransform:'uppercase',textShadow:'0 0 14px rgba(50,224,196,.75)',opacity:'0',filter:'blur(1px)',fontSize:'clamp(12px,2.6vw,24px)',pointerEvents:'none'});
    el.textContent=w; canvas.parentElement.appendChild(el);
    let a=0; (function anim(){ a+=0.03; el.style.opacity=String(Math.sin(a)*0.9); if(a<Math.PI) requestAnimationFrame(anim); else el.remove(); })();
  }

  addEventListener('keydown', (e)=>{
    if (e.code==='Space'){ e.preventDefault(); markMoment(); }
    else if (e.key==='h'||e.key==='H'){ hintSlider.value = (hintSlider.value>0?0:0.18); }
    else if (e.key==='s'||e.key==='S'){ toggleScry(); }
    else if (e.key==='r'||e.key==='R'){ reseed(); latentSigil=makeSigil(); }
    else if (e.key==='g'||e.key==='G'){ glowWord(); }
  });

  // On iOS, RAF may be throttled until interaction. Tap to “wake” if needed.
  document.addEventListener('touchstart', ()=>{}, {passive:true});

})();
</script>
</body>
</html>
