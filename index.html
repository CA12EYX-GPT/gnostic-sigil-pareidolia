<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gnostic Sigil Pareidolia — Waterfall</title>
<meta name="color-scheme" content="dark">
<style>
  :root {
    --bg: #0b0b0b;
    --fg: #e6e6e6;
    --muted: #9aa0a6;
    --glow: #00e0d1; /* teal glow for real words */
  }
  /* Reset + base */
  html, body { height: 100%; }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    background: var(--bg);
    color: var(--fg);
    font: 16px/1.25 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    letter-spacing: 0.02em;
    -webkit-font-smoothing: antialiased;
    text-rendering: optimizeLegibility;
    overflow: hidden; /* full-screen canvas vibe */
  }

  /* Header / mode indicator */
  .bar {
    position: fixed; inset: 0 0 auto 0; height: 44px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 12px;
    background: linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,0));
    backdrop-filter: blur(2px);
    pointer-events: none; /* clicks pass through except on controls we re-enable */
  }
  .brand { opacity: .75; font-weight: 600; }
  .mode {
    pointer-events: auto; /* allow interaction */
    font-size: 12px;
    color: var(--muted);
    padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.03);
    user-select: none;
  }
  .button {
    pointer-events: auto;
    font-size: 12px;
    color: var(--fg);
    padding: 4px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    cursor: pointer;
    margin-left: 8px;
  }
  .button:focus-visible { outline: 2px solid var(--glow); outline-offset: 2px; }
  .hint { opacity: .6; font-size: 12px; margin-left: 8px; }

  /* App/grid */
  #app { position: fixed; inset: 0; display: grid; place-items: center; }
  #grid {
    width: 96vw; height: 86vh;
    display: grid;
    grid-template-rows: repeat(24, 1fr);
    gap: 2px;
    filter: drop-shadow(0 1px 0 rgba(255,255,255,.04));
  }
  .row { display: grid; grid-template-columns: repeat(64, 1fr); gap: 2px; }

  .cell {
    display: flex; align-items: center; justify-content: center;
    min-width: 0;
    opacity: .95;
    transition: opacity .15s linear, transform .15s linear;
    will-change: contents, opacity;
  }

  .word { color: var(--glow); text-shadow: 0 0 8px var(--glow); font-weight: 600; }
  .sigil { filter: drop-shadow(0 0 6px var(--fg)); }

  /* Subtle shimmer */
  @keyframes shimmer { 0% { opacity: .94; } 50% { opacity: .98; } 100% { opacity: .94; } }
  #grid { animation: shimmer 6s ease-in-out infinite; }

  /* Ritual mode intensifies the vibe slightly */
  .ritual .cell { opacity: .97; }
  .ritual #grid { animation-duration: 4.5s; }

  /* Leader sigil that heads each row */
.leader {
  filter: drop-shadow(0 0 10px rgba(255,255,255,.55));
  font-weight: 700;
  transform: translateZ(0);
}
</style>
</head>
<body>
  <!-- Top bar -->
  <div class="bar" role="region" aria-label="Controls">
    <div class="brand">Gnostic Sigil Pareidolia</div>
    <div>
      <span id="mode" class="mode" aria-live="polite">Mode: Normal</span>
      <button id="toggle-ritual" class="button" type="button" aria-pressed="false">Toggle Ritual (R)</button>
      <span class="hint">Press <kbd>R</kbd> or click</span>
    </div>
  </div>

  <!-- App mount -->
  <div id="app" aria-live="polite" aria-busy="false">
    <div id="grid"></div>
  </div>

<script>
/* Waterfall (row-wise) with a persistent leader sigil per row */
(function(){
  // Config
  const COLS = 64, ROWS = 24;
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const leaderSigils = ["◉","∆","⟁","✧","◬","◆"];
  const words = ["THE","AND","YOU","SIG","ART","SEA","SUN","GOD","ARC","ORB","KEY","EYE","GNOS","SIGIL"];

  // DOM refs (guarded)
  const gridEl = document.getElementById('grid');
  const modeEl = document.getElementById('mode');
  const toggleBtn = document.getElementById('toggle-ritual');

  if(!gridEl){
    console.error("Mount element missing (#grid).");
    return;
  }

  // Build DOM once
  const rows = [];
  for(let r=0;r<ROWS;r++){
    const row = document.createElement('div');
    row.className = 'row';
    const cells = [];
    for(let c=0;c<COLS;c++){
      const span = document.createElement('span');
      span.className = 'cell';
      span.textContent = letters[(Math.random()*letters.length)|0];
      row.appendChild(span);
      cells.push(span);
    }
    gridEl.appendChild(row);
    rows.push(cells);
  }

  // Ritual state + helpers
  let ritual = false;
  function setMode(isRitual){
    ritual = !!isRitual;
    document.body.classList.toggle('ritual', ritual);
    if(modeEl) modeEl.textContent = ritual ? "Mode: Ritual" : "Mode: Normal";
    if(toggleBtn) toggleBtn.setAttribute('aria-pressed', ritual ? 'true' : 'false');
  }

  // Click support (mobile-safe)
  toggleBtn?.addEventListener('click', () => setMode(!ritual));

  // Keyboard support (desktop)
  function isTypingInField(t){
    return t && (t.isContentEditable || ['INPUT','TEXTAREA','SELECT'].includes(t.tagName));
  }
  document.addEventListener('keydown', (e)=>{
    if (isTypingInField(e.target)) return;
    const k = (e.key || '').toLowerCase();
    if (k === 'r') { e.preventDefault(); setMode(!ritual); }
  });

  // Word glow helper (3–5 chars) — triggered *behind* the leader
  function maybeGlow(rowIdx, head){
    const len = 3 + (Math.random() < (ritual ? 0.45 : 0.25) ? 1 : 0) + (Math.random() < (ritual ? 0.20 : 0.10) ? 1 : 0);
    if(head - len + 1 < 0) return;
    const word = words[(Math.random()*words.length)|0];
    const txt = word.slice(0, Math.min(len, word.length));
    for(let i=0;i<txt.length;i++){
      const cell = rows[rowIdx][head - (txt.length-1-i)];
      if(!cell) return;
      cell.textContent = txt[i];
      cell.classList.add('word');
      setTimeout(()=>cell.classList.remove('word'), ritual ? 1100 : 800);
    }
  }

  // Per-row leader state
  const heads = Array.from({length: ROWS}, ()=> 0);
  const leaderChars = Array.from({length: ROWS}, (_,r)=> leaderSigils[r % leaderSigils.length]);

  // Initialize leaders at col 0
  for(let r=0;r<ROWS;r++){
    const c0 = rows[r][0];
    c0.textContent = leaderChars[r];
    c0.classList.add('leader');
  }

  let rafId = 0;

  // Core tick: the leader moves one step; the cell it leaves behind becomes a new character (and may spark a word)
  function step(){
    for(let r=0;r<ROWS;r++){
      const prev = heads[r];
      const next = (prev + 1) % COLS;

      // 1) Clear previous leader -> becomes changing letter (the "waterfall" change)
      const prevCell = rows[r][prev];
      if(prevCell){
        prevCell.classList.remove('leader');
        // Subtle flicker to show change happened
        if(Math.random() < (ritual ? 0.04 : 0.025)){
          prevCell.style.opacity = "0.7";
          setTimeout(()=>{ prevCell.style.opacity = "0.95"; }, 160);
        }
        // The leaving leader *causes* the change behind it
        prevCell.textContent = letters[(Math.random()*letters.length)|0];
        // Occasional word formation behind the leader
        const wordChance = ritual ? 0.14 : 0.1;
        if(Math.random() < wordChance) maybeGlow(r, prev);
      }

      // 2) Set the leader at the new head
      const headCell = rows[r][next];
      if(headCell){
        headCell.textContent = leaderChars[r];
        headCell.classList.add('leader');
      }

      heads[r] = next;
    }
    rafId = requestAnimationFrame(step);
  }

  // Start after paint
  requestAnimationFrame(()=>{
    step();
    console.log("Waterfall with leader sigil started");
  });

  // Pause when hidden to save cycles
  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden){ cancelAnimationFrame(rafId); }
    else{ rafId = requestAnimationFrame(step); }
  });
})();
</script>

</body>
</html>
